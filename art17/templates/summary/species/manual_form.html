{% from '_macros.html' import conclusion_td with context %}

{% if not manual_assessment %}
    {% set operation = 'add' %}
{% else %}
    {% set operation = 'update' %}
{% endif %}

{% set can_select_MS = can_select_MS_country_code(operation) %}

{% set form=manual_form %}
<form class="form" method="post" action="">
  <tr class="form_row">
    <th>{% if can_select_MS %}MS{% endif %}</th>
    {% if not region %}
    <th>Region</th>
    {% endif %}

    <th>Area</th>
    <th>Range Concl.</th>
    <th>Trend</th>
    <th>Ref.</th>
    
    <th>Size&amp;Unit</th>
    <th>Pop. Concl.</th>
    <th>Trend</th>
    <th>Ref.</th>
    
    <th>Area</th>
    <th>Habitat Concl.</th>
    <th></th>
    <th>Trend</th>
    <th>Suitable</th>

    <th>Future prosp.</th>

    <th>Curr. CS Concl.</th>
    <th>Trend CS</th>
    <th>Prev. CS Concl.</th>
    <th>Nat. of ch.</th>

    <th>Contrib.</th>
    <th>Type</th>

    <th colspan="9">
    </th>
  </tr>
  <tr class="form_row">
    <td>{% if can_select_MS %}{{ form.MS() }}{% endif %}</td>
    {% if not region %}
    <td>{{ form.region() }}</td>
    {% endif %}

    {% if not edit_ref %}
      {# Range #}
      <td {% if form.range_surface_area.errors %}class="errors"{% endif %}>
      {{ form.range_surface_area(size=5) }}
      </td>
      <td class="{% if form.method_range.errors or form.conclusion_range.errors %}errors{% endif %}">

        <div class="conclusion popout-wrapper">
          <div class="popout assesment caret">
            <div class="popout-title">
              <a class="close pull-right"><i class="fa fa-times"></i></a>
              Range Conclusion
            </div>
            <div class="form-group clearfix no-bottom">
              <label class="pull-left no-bottom">Method</label>
              <div class="width-third pull-right">{{ form.method_range() }}</div>
            </div>
            <hr>
            <div class="form-group no-bottom">
              <label class="no-bottom">Conclusion</label>
              <ul class="select-list no-list">
                <!-- Sablon-Template-Macro -->
                <li class="clearfix">
                  <label  class="radio-label FV conclusion inline width-third pull-right"
                          for="radio-range-fv">
                          FV
                          <input  id="radio-range-fv"
                                  type="radio" 
                                  name="range_conclusion" 
                                  value="FV"
                                  data-class="FV"> 
                  </label> Favourable
                </li>
                <!--/Sablon-Template-Macro -->
                <li class="clearfix">
                  <label  class="radio-label U1 conclusion inline width-third pull-right"
                          for="radio-range-u1">
                          U1
                          <input  id="radio-range-u1"
                                  type="radio" 
                                  name="range_conclusion" 
                                  value="U1"> 
                  </label> Inadequate
                </li>
                <li class="clearfix">
                  <label  class="radio-label U2 conclusion inline width-third pull-right"
                          for="radio-range-U2">
                          U2
                          <input  id="radio-range-U2"
                                  type="radio" 
                                  name="range_conclusion" 
                                  value="U2"> 
                  </label> Unfavourable
                </li>
                <li class="clearfix">
                  <label  class="radio-label XX conclusion inline width-third pull-right"
                          for="radio-range-xx">
                          XX
                          <input  id="radio-range-xx"
                                  type="radio" 
                                  name="range_conclusion" 
                                  value="XX"> 
                  </label> Unknown
                </li>
              </ul>
            </div>
            {# {{ form.conclusion_range() }} #}
          </div>
          <a class="conclusion select block" tab-index data-popout="assesment">
            <span class="selected-value hidden"></span>
            <i class="fa fa-hand-o-up"></i>
          </a>
        </div>
      </td>
      <td {% if form.range_trend.errors %}class="errors"{% endif %}>
      {{ form.range_trend() }}
      </td>
      <td {% if form.complementary_favourable_range.errors %}class="errors"{% endif %}>
      {{ form.complementary_favourable_range(size=5) }}
      </td>

      {# Population #}
      <td {% if form.population_size.errors or form.population_size_unit.errors %}class="errors"{% endif %}>
        <!--Sablon Size-unit -->
        <div class="conclusion popout-wrapper">
          <div class="popout size_unit caret width-120">
            <a class="close pull-right"><i class="fa fa-times"></i></a>
            <div class="form-group clearfix no-bottom">
              <label class="pull-left no-bottom">Size</label>
              <div class="width-2third pull-right">{{ form.population_size(size=5) }}</div>
            </div>
            <div class="form-group clearfix no-bottom">
              <label class="pull-left no-bottom">Unit</label>
              <div class="width-2third pull-right">{{ form.population_size_unit() }}</div>
            </div>
          </div>
          <a class="select block" tab-index data-popout="size_unit">
            <span class="selected-value hidden"></span>
            <i class="fa fa-hand-o-up"></i>
          </a>
        </div>
        <!--/Sablon Size-unit -->
      </td>
      <td {% if form.method_population.errors or form.conclusion_population.errors %}class="errors"{% endif %}>
      {{ form.method_population() }}
      {{ form.conclusion_population() }}
      </td>
      <td {% if form.population_trend.errors %}class="errors"{% endif %}>
      {{ form.population_trend() }}
      </td>
      <td {% if form.complementary_favourable_population.errors %}class="errors"{% endif %}>
      {{ form.complementary_favourable_population(size=5) }}
      </td>

      {# Habitat #}
      <td {% if form.habitat_surface_area.errors %}class="errors"{% endif %}>
      {{ form.habitat_surface_area(size=5) }}
      </td>
      <td {% if form.method_habitat.errors or form.conclusion_habitat.errors %}class="errors"{% endif %}>
      {{ form.method_habitat() }}
      {{ form.conclusion_habitat() }}
      </td>
      <td></td>
      <td {% if form.habitat_trend.errors %}class="errors"{% endif %}>
      {{ form.habitat_trend() }}
      </td>
      <td {% if form.complementary_suitable_habitat.errors %}class="errors"{% endif %}>
      {{ form.complementary_suitable_habitat(size=5) }}
      </td>

      {# FP #}
      <td {% if form.method_future.errors or form.conclusion_future.errors %}class="errors"{% endif %}>
      {{ form.method_future() }}
      {{ form.conclusion_future() }}
      </td>

      {# Overall #}
      <td {% if form.method_assessment.errors or form.conclusion_assessment.errors %}class="errors"{% endif %}>
      {{ form.method_assessment() }}
      {{ form.conclusion_assessment() }}
      </td>
      <td {% if form.conclusion_assessment_trend.errors %}class="errors"{% endif %}>
      {{ form.conclusion_assessment_trend() }}
      </td>
      <td {% if form.conclusion_assessment_prev.errors %}class="errors"{% endif %}>
      {{ form.conclusion_assessment_prev() }}
      </td>
      <td {% if form.conclusion_assessment_change.errors %}class="errors"{% endif %}>
      {{ form.conclusion_assessment_change() }}
      </td>

      {# Contrib target 1 #}
      <td {% if form.method_target1.errors %}class="errors"{% endif %}>
      {{ form.method_target1(title="A (favorable), B (improvement), C (deterioration), D (same), E (unknown)") }}
      </td>
      <td {% if form.conclusion_target1.errors %}class="errors"{% endif %}>
      {{ form.conclusion_target1(title="+ (improvement), - (deterioration), 0 (no change), x (not known)") }}
      </td>
    {% else %}
      {# Edit reference values form #}
      {% set ass = manual_assessment %}
      <td>{{ ass.range_surface_area }}</td>
      {{ conclusion_td(ass.conclusion_range, ass.method_range) }}
      <td>{{ ass.range_trend }}</td>
      <td {% if form.complementary_favourable_range.errors %}class="errors"{% endif %}>
        {{ form.complementary_favourable_range(size=5) }}
      </td>

      <td>{{ ass.population_size }}
          {{ ass.population_size_unit }}</td>
      {{ conclusion_td(ass.conclusion_population, ass.method_population) }}
      <td>{{ ass.population_trend }}</td>
      <td {% if form.complementary_favourable_population.errors %}class="errors"{% endif %}>
        {{ form.complementary_favourable_population(size=5) }}
      </td>

      <td>{{ ass.habitat_surface_area }}</td>
      {{ conclusion_td(ass.conclusion_habitat, ass.method_habitat) }}
      <td></td>
      <td>{{ ass.habitat_trend }}</td>
      <td>{{ ass.complementary_suitable_habitat }}</td>

      {# FP #}
      {{ conclusion_td(ass.conclusion_future, ass.method_future) }}

      {# Overall #}
      {{ conclusion_td(ass.conclusion_assessment, ass.method_range) }}
      <td>{{ ass.conclusion_assessment_trend }}</td>
      <td>{{ ass.conclusion_assessment_prev }}</td>
      <td>{{ ass.conclusion_assessment_change }}</td>

      {{ conclusion_td(ass.conclusion_target1, ass.method_target1, colspan=2) }}
    {% endif %}

    {% if not manual_assessment %}
    <td colspan="9">
      <button class="btn-green" type="submit" name="submit" value="add">Add assesment</button>
    </td>
    {% else %}
    {% set row=manual_assessment %}
    <td colspan="2">
      <input type="hidden" name="subject" value="{{ subject }}" />
      <input type="hidden" name="region" value="{{ row.region }}" />
      <input type="hidden" name="user" value="{{ row.user_id }}" />
      <button type="submit" name="submit" value="update">update</button>
      <a href="" class="btn-text">cancel</a>
    </td>
    {% include 'summary/common/manual/conclusion_details.html' %}
    {% endif %}
  </tr>
  {% if form.errors %}
  <tr>
    <td colspan="{{ colspan_all }}">
      Errors:
        {{ form.all_errors()|safe }}
    </td>
  </tr>
  {% endif %}
</form>
