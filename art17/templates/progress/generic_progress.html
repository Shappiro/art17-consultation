{% extends layout_template %}

{% block content %}
    {% block text_description %}{% endblock text_description %}

    {% include 'progress/filters.html' %}

    {% if current_selection %}

    {% include 'common/note_progress.html' %}
    {% include 'common/table_legend.html' %}

    <table class="complex_datatable">
      <caption>
        <b>Current selection</b>:
        {{ current_selection|join(', ') }}.
      </caption>

      <thead>
        <tr>
          <th class="text-left" rowspan="2">
            {% block first_column_title %}{% endblock first_column_title %}
          </th>
          <th colspan="{{ regions|count }}">Regions</th>
        </tr>
        <tr>
          {% for region in regions %}
          <th>
            {{ region.reg_code }}
          </th>
          {% endfor %}
        </tr>
      </thead>

      <tbody class="stripe_3rd">
        {% for subject in subjects %}
            {% set subject_name, subject_title = subject %}
            <tr>
              <td class="th">
                {{ subject_title }}
              </td>
              {% for region in regions %}
                {% set data = objects.get(subject_name, {}).get(region.reg_code, '') %}
                {% set url = url_for(summary_endpoint,
                              period=dataset.id, subject=subject_name,
                              region=region.reg_code) %}
                {% if data %}
                  {% set key = (subject_name, region.reg_code) %}
                  {% set cc_user = comment_counts['user'].get(key, 0) %}
                  {% set cc_all = comment_counts['all'].get(key, 0) %}
                  {% set cc_wiki = comment_counts['wiki'].get(key, 0) %}
                  {% set title = data.get('title', '') + "

                  Unread comments for my conclusions: {0}
                  Unread comments for all conclusions: {1}
                  Unread comments for data sheet info: {2}".format(
                  cc_user, cc_all, cc_wiki) %}

                  <td class="{{ CONCLUSION_CLASSES[data['conclusion']] }}"
                      title="{{ title }}"
                      data-tooltip-place="s">
                        <a href="{{ url }}" class="conclusion">
                        {% if can_view_details() %}
                          {{ data['main_decision'] }}
                          {{ ' '.join(data['other_decisions']) }}
                          {{ data['method']|methodify }}
                          <br/>
                          {{ cc_user }} {{cc_all}} {{cc_wiki}}
                        {% else %}
                          {{ data['method']|methodify }}
                        {% endif %}
                        </a>
                  </td>
                {% else %}
                  <td></td>
                {% endif %}
              {% endfor %}
            </tr>
            {% if loop.index % 25 == 0 
               and loop.length - loop.index >= 10 %}
                <tr class="thead">
                  <th class="text-center italic large" rowspan="2">
                    <span class="italic muted">
                    {{ loop.index }} - 
                    {% if loop.index + 25 > loop.length %}
                      {{ loop.length }}
                    {% else %}
                      {{ loop.index + 25 }}
                    {% endif %}
                    </span>
                  </th>
                  <th colspan="{{ regions|count }}">Regions</th>
                </tr>
                <tr class="thead">
                  {% for region in regions %}
                  <th>
                    {{ region.reg_code }}
                  </th>
                  {% endfor %}
                </tr>
            {% endif %}
        {% endfor %}
      </tbody>
    </table>
    {% else %}
        <p><b>Please select a group and a conclusion.</b></p>
    {% endif %}

{% endblock %}
